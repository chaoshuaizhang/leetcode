---
tags: [工作/调研]
title: 暗黑模式调研
created: '2020-09-03T09:31:14.131Z'
modified: '2020-09-04T13:13:55.673Z'
---

# 暗黑模式调研

两个最重要的主题背景属性：

* `?android:attr/textColorPrimary`这是一种通用型文本颜色。它在浅色主题背景下接近于黑色，在深色主题背景下接近于白色。该颜色包含一个停用状态。
* `?attr/colorControlNormal`一种通用图标颜色。该颜色包含一个停用状态。

>针对这两个颜色，有些疑问，怎么用？谁去用？

## 9.0前后适配

1. 当应用在搭载 Android 9 或更低版本的设备上运行时，推荐的主题背景选项是：
* 浅色 `MODE_NIGHT_NO`
* 深色 `MODE_NIGHT_YES`
* 由省电模式设置（推荐的默认选项） `MODE_NIGHT_AUTO_BATTERY`

2. 应用在 Android 10 (API 级别 29) 及更高版本上运行时，推荐的选项有所不同，目的是允许用户替换系统默认设置：

* 浅色 `MODE_NIGHT_NO`
* 深色 `MODE_NIGHT_YES`
* 系统默认（推荐的默认选项） `MODE_NIGHT_FOLLOW_SYSTEM`

调用`AppCompatDelegate.setDefaultNightMode()`传入上述的几种模式，来进行主题切换。
>调用setDefaultNightMode会造成Activity的重建。【这里会存在一个问题：recreate会造成闪屏，根据手机系统不同，闪屏带来的视觉影响也不同】

## 遇到的问题

1. Activity的recreate导致闪屏，解决办法：
>单独执行recreate方法也会闪屏，具体原因未知
* 看到系统有两个设置暗夜模式的方法
```
    @Override
public boolean applyDayNight() {
    return applyDayNight(true);
}

// 私有的，我们无法调用
private boolean applyDayNight(final boolean allowRecreation) {
    // 返回值applied：true->暗夜生效，false->未生效
    final boolean applied = updateForNightMode(modeToApply, allowRecreation)
}

// 如果允许重建，则就重建activity
if (allowRecreation) {
	  ActivityCompat.recreate((Activity) mHost);
}
```
>看到这个带参数的applyDayNight方法后，想到的解决方案是：默认不重建，重建动作交给自己来执行（startActivity + animation），这样就避免了执行recreate方法时闪屏。



